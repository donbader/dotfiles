# Phase 4: Analyze PR Context

**Determine review mode**:

```bash
# Parse GraphQL response to count thread statuses
unresolved_count=$(echo "$thread_data" | jq '[.data.repository.pullRequest.reviewThreads.nodes[] | 
  select(.isResolved == false) | 
  select(.comments.nodes[0].body | contains("ü§ñ Generated by OpenCode"))] | length')

resolved_count=$(echo "$thread_data" | jq '[.data.repository.pullRequest.reviewThreads.nodes[] | 
  select(.isResolved == true) | 
  select(.comments.nodes[0].body | contains("ü§ñ Generated by OpenCode"))] | length')

total_previous_reviews=$((unresolved_count + resolved_count))

# Determine review mode based on state
if [ "$total_previous_reviews" -eq 0 ]; then
  echo "=== MODE: FIRST REVIEW ==="
  review_mode="first"
  diff_range="${base_branch}..HEAD"
  
elif [ "$unresolved_count" -gt 0 ]; then
  echo "=== MODE: RE-REVIEW (${unresolved_count} unresolved threads) ==="
  review_mode="re-review"
  
  # Get last review commit for new changes detection
  last_review_commit=$(echo "$review_history" | jq -r '
    .data.repository.pullRequest.reviews.nodes[] | 
    select(.body | contains("ü§ñ Generated by OpenCode") or contains("ü§ñ Re-reviewed by OpenCode")) | 
    .commit.oid' | head -1)
  
  if [ -n "$last_review_commit" ]; then
    diff_range="${last_review_commit}..HEAD"
    echo "Will also review new commits since last review: $last_review_commit"
  else
    diff_range="${base_branch}..HEAD"
  fi
  
elif [ "$resolved_count" -gt 0 ] && [ "$unresolved_count" -eq 0 ]; then
  echo "=== MODE: INCREMENTAL REVIEW (All ${resolved_count} previous threads resolved) ==="
  review_mode="incremental"
  
  # Get last review commit
  last_review_commit=$(echo "$review_history" | jq -r '
    .data.repository.pullRequest.reviews.nodes[] | 
    select(.body | contains("ü§ñ Generated by OpenCode") or contains("ü§ñ Re-reviewed by OpenCode")) | 
    .commit.oid' | head -1)
  
  current_commit=$(git rev-parse HEAD)
  
  if [ -z "$last_review_commit" ]; then
    echo "‚ö†Ô∏è  Could not find last review commit - falling back to full review"
    review_mode="first"
    diff_range="${base_branch}..HEAD"
    
  elif [ "$last_review_commit" = "$current_commit" ]; then
    echo "‚úÖ No new changes since last review - PR ready for merge"
    echo ""
    echo "All previous issues resolved and no new commits added."
    echo "The PR is ready for human approval and merge."
    exit 0
    
  else
    echo "üìù New commits detected - reviewing incremental changes only"
    diff_range="${last_review_commit}..HEAD"
    
    # Show what's new
    new_commits=$(git log --oneline "$last_review_commit".."$current_commit")
    commit_count=$(echo "$new_commits" | wc -l | tr -d ' ')
    
    echo ""
    echo "New commits since last review ($commit_count):"
    echo "$new_commits"
    
    files_changed=$(git diff --name-only "$last_review_commit".."$current_commit")
    echo ""
    echo "Files changed since last review:"
    echo "$files_changed"
  fi
fi
```

**CRITICAL**: Do NOT rely on comment replies to determine resolution status
- Threads with author replies may still be unresolved (`isResolved: false`)
- Only threads explicitly marked as resolved (`isResolved: true`) should be skipped
- Always use GraphQL `reviewThreads.nodes[].isResolved` field to filter

**For first reviews**, extract PR context from description:
1. **Purpose**: What is the author trying to achieve?
2. **Scope**: Bug fix, feature, refactor, hotfix?
3. **Constraints**: Any trade-offs or technical debt mentioned?
4. **Testing**: What testing approach was taken?
